<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Deploying Azure DevTest Labs Policies with ARM Templates. An incomplete guide to some challenging Azure resources."><title>Building DevTest Labs ARM Template Policies</title><link rel=canonical href=https://blog.mattdaines.me/p/building-devtest-labs-arm-template-policies/><link rel=stylesheet href=/scss/style.min.b80bf249ce4a22cf55e8d7340a0b37a2f2c10f54f3a9a49cb94b694a2eb0bbea.css><meta property="og:title" content="Building DevTest Labs ARM Template Policies"><meta property="og:description" content="Deploying Azure DevTest Labs Policies with ARM Templates. An incomplete guide to some challenging Azure resources."><meta property="og:url" content="https://blog.mattdaines.me/p/building-devtest-labs-arm-template-policies/"><meta property="og:site_name" content="Matt Daines"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Azure"><meta property="article:tag" content="DevTest Labs"><meta property="article:tag" content="ARM Templates"><meta property="article:published_time" content="2021-02-15T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-15T00:00:00+00:00"><meta property="og:image" content="https://blog.mattdaines.me/img/avatar.jpeg"><meta name=twitter:site content="@MatthewDaines1"><meta name=twitter:creator content="@MatthewDaines1"><meta name=twitter:title content="Building DevTest Labs ARM Template Policies"><meta name=twitter:description content="Deploying Azure DevTest Labs Policies with ARM Templates. An incomplete guide to some challenging Azure resources."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.mattdaines.me/img/avatar.jpeg"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu1f9973605cefc906a06aa7420d62a8b9_6051_300x0_resize_q75_box.jpeg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>👨🏻‍💻</span></figure><div class=site-meta><h1 class=site-name><a href=/>Matt Daines</a></h1><h2 class=site-description>Azure security and infrastructure consultant. Welcome to my scrapbook!</h2></div></header><ol class=social-menu><li><a href=https://twitter.com/MatthewDaines1 target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://www.linkedin.com/in/matthew-daines/ target=_blank title=LinkedIn><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="8" y1="11" x2="8" y2="16"/><line x1="8" y1="8" x2="8" y2="8.01"/><line x1="12" y1="16" x2="12" y2="11"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li><li><a href=https://github.com/MattDaines target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://app.pluralsight.com/profile/matthew-daines target=_blank title=Pluralsight><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="44" height="44"><defs><path d="M.742 21.441c0 11.38 9.172 20.618 20.531 20.715h.368C33 42.06 42.176 32.82 42.176 21.441 42.176 10 32.898.723 21.457.723S.742 10 .742 21.44" id="a"/><linearGradient x1="49.997%" y1=".003%" x2="49.997%" y2="100.002%" id="b"><stop stop-color="#f05a28" offset="0"/><stop stop-color="#f05a28" offset="1.563%"/><stop stop-color="#f05a28" offset="2.344%"/><stop stop-color="#f05929" offset="3.125%"/><stop stop-color="#f0582a" offset="3.906%"/><stop stop-color="#f0582b" offset="4.688%"/><stop stop-color="#f0572c" offset="5.469%"/><stop stop-color="#f0562c" offset="6.25%"/><stop stop-color="#f0552d" offset="7.031%"/><stop stop-color="#f0552e" offset="7.813%"/><stop stop-color="#f0542f" offset="8.594%"/><stop stop-color="#f0532f" offset="9.375%"/><stop stop-color="#f05330" offset="10.156%"/><stop stop-color="#f05231" offset="10.938%"/><stop stop-color="#f05132" offset="11.719%"/><stop stop-color="#ef5033" offset="12.5%"/><stop stop-color="#ef5033" offset="13.281%"/><stop stop-color="#ef4f34" offset="14.063%"/><stop stop-color="#ef4e35" offset="14.844%"/><stop stop-color="#ef4e36" offset="15.625%"/><stop stop-color="#ef4d36" offset="16.406%"/><stop stop-color="#ef4c37" offset="17.188%"/><stop stop-color="#ef4b38" offset="17.969%"/><stop stop-color="#ef4b39" offset="18.75%"/><stop stop-color="#ef4a3a" offset="19.531%"/><stop stop-color="#ef493a" offset="20.313%"/><stop stop-color="#ef493b" offset="21.094%"/><stop stop-color="#ef483c" offset="21.875%"/><stop stop-color="#ef473d" offset="22.656%"/><stop stop-color="#ef463d" offset="23.438%"/><stop stop-color="#ef463e" offset="24.219%"/><stop stop-color="#ef453f" offset="25%"/><stop stop-color="#ef4440" offset="25.781%"/><stop stop-color="#ef4441" offset="26.563%"/><stop stop-color="#ef4341" offset="27.344%"/><stop stop-color="#ef4242" offset="28.125%"/><stop stop-color="#ef4143" offset="28.906%"/><stop stop-color="#ef4144" offset="29.688%"/><stop stop-color="#ef4045" offset="30.469%"/><stop stop-color="#ef3f45" offset="31.25%"/><stop stop-color="#ee3f46" offset="32.031%"/><stop stop-color="#ee3e47" offset="32.813%"/><stop stop-color="#ee3d48" offset="33.594%"/><stop stop-color="#ee3c48" offset="34.375%"/><stop stop-color="#ee3c49" offset="35.156%"/><stop stop-color="#ee3b4a" offset="35.938%"/><stop stop-color="#ee3a4b" offset="36.719%"/><stop stop-color="#ee3a4c" offset="37.5%"/><stop stop-color="#ee394c" offset="38.281%"/><stop stop-color="#ee384d" offset="39.063%"/><stop stop-color="#ee384e" offset="39.844%"/><stop stop-color="#ee374f" offset="40.625%"/><stop stop-color="#ee364f" offset="41.406%"/><stop stop-color="#ee3550" offset="42.188%"/><stop stop-color="#ee3551" offset="42.969%"/><stop stop-color="#ee3452" offset="43.75%"/><stop stop-color="#ee3353" offset="44.531%"/><stop stop-color="#ee3353" offset="45.313%"/><stop stop-color="#ee3254" offset="46.094%"/><stop stop-color="#ee3155" offset="46.875%"/><stop stop-color="#ee3056" offset="47.656%"/><stop stop-color="#ee3057" offset="48.438%"/><stop stop-color="#ee2f57" offset="49.219%"/><stop stop-color="#ee2e58" offset="50%"/><stop stop-color="#ee2e59" offset="50.781%"/><stop stop-color="#ed2d5a" offset="51.563%"/><stop stop-color="#ed2c5a" offset="52.344%"/><stop stop-color="#ed2b5b" offset="53.125%"/><stop stop-color="#ed2b5c" offset="53.906%"/><stop stop-color="#ed2a5d" offset="54.688%"/><stop stop-color="#ed295e" offset="55.469%"/><stop stop-color="#ed295e" offset="56.25%"/><stop stop-color="#ed285f" offset="57.031%"/><stop stop-color="#ed2760" offset="57.813%"/><stop stop-color="#ed2661" offset="58.594%"/><stop stop-color="#ed2661" offset="59.375%"/><stop stop-color="#ed2562" offset="60.156%"/><stop stop-color="#ed2463" offset="60.938%"/><stop stop-color="#ed2464" offset="61.719%"/><stop stop-color="#ed2365" offset="62.5%"/><stop stop-color="#ed2265" offset="63.281%"/><stop stop-color="#ed2166" offset="64.063%"/><stop stop-color="#ed2167" offset="64.844%"/><stop stop-color="#ed2068" offset="65.625%"/><stop stop-color="#ed1f69" offset="66.406%"/><stop stop-color="#ed1f69" offset="67.188%"/><stop stop-color="#ed1e6a" offset="67.969%"/><stop stop-color="#ed1d6b" offset="68.75%"/><stop stop-color="#ed1c6c" offset="69.531%"/><stop stop-color="#ed1c6c" offset="70.313%"/><stop stop-color="#ed1b6d" offset="71.094%"/><stop stop-color="#ec1a6e" offset="71.875%"/><stop stop-color="#ec1a6f" offset="72.656%"/><stop stop-color="#ec1970" offset="73.438%"/><stop stop-color="#ec1870" offset="74.219%"/><stop stop-color="#ec1871" offset="75%"/><stop stop-color="#ec1772" offset="75.781%"/><stop stop-color="#ec1673" offset="76.563%"/><stop stop-color="#ec1573" offset="77.344%"/><stop stop-color="#ec1574" offset="78.125%"/><stop stop-color="#ec1475" offset="78.906%"/><stop stop-color="#ec1376" offset="79.688%"/><stop stop-color="#ec1377" offset="80.469%"/><stop stop-color="#ec1277" offset="81.25%"/><stop stop-color="#ec1178" offset="82.031%"/><stop stop-color="#ec1079" offset="82.813%"/><stop stop-color="#ec107a" offset="83.594%"/><stop stop-color="#ec0f7b" offset="84.375%"/><stop stop-color="#ec0e7b" offset="85.156%"/><stop stop-color="#ec0e7c" offset="85.938%"/><stop stop-color="#ec0d7d" offset="86.719%"/><stop stop-color="#ec0c7e" offset="87.5%"/><stop stop-color="#ec0b7e" offset="88.281%"/><stop stop-color="#ec0b7f" offset="89.063%"/><stop stop-color="#ec0a80" offset="89.844%"/><stop stop-color="#ec0981" offset="90.625%"/><stop stop-color="#eb0982" offset="91.406%"/><stop stop-color="#eb0882" offset="92.188%"/><stop stop-color="#eb0783" offset="92.969%"/><stop stop-color="#eb0684" offset="93.75%"/><stop stop-color="#eb0685" offset="94.531%"/><stop stop-color="#eb0585" offset="95.313%"/><stop stop-color="#eb0486" offset="96.094%"/><stop stop-color="#eb0487" offset="96.875%"/><stop stop-color="#eb0388" offset="97.656%"/><stop stop-color="#eb0289" offset="98.438%"/><stop stop-color="#eb0189" offset="99.219%"/><stop stop-color="#eb018a" offset="100%"/></linearGradient><path id="d" d="M0 0h9.262v13H0z"/></defs><g fill="none" fill-rule="evenodd"><mask id="c" fill="#fff"><g/></mask><path fill="url(#b)" fill-rule="nonzero" mask="url(#c)" d="M42.176.723H.742v41.433h41.434z"/><path d="M5.133.676v21.531l18.644-10.766-18.644-10.765zm1.785 3.09 13.289 7.675-13.289 7.672V13.766z" fill="#fff" fill-rule="nonzero"/><path d="M.844 3.027l14.574 8.414-14.574 8.414V13.027zm1.785 3.09v10.649l9.223-5.325-9.223-5.324z" fill="#fff" fill-rule="nonzero"/></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/azure/ style=background-color:#0072c6;color:#fff>Azure</a>
<a href=/categories/iac/ style=background-color:#0072c6;color:#fff>Infrastrucure-as-Code</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/building-devtest-labs-arm-template-policies/>Building DevTest Labs ARM Template Policies</a></h2><h3 class=article-subtitle>Deploying Azure DevTest Labs Policies with ARM Templates. An incomplete guide to some challenging Azure resources.</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Feb 15, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><p>I&rsquo;ve recently been ARM templating again! In this article I&rsquo;ll go through how I&rsquo;ve templated a relatively troublesome resource: <code>Microsoft.DevTestLab/labs/policysets/policies</code>. The documentation for this resource type is quite scarce so I figured I&rsquo;d try figure out how to template at least some of the policies. Maybe you&rsquo;ll find something useful.</p><h3 id=devtest-labs-parent-resource>DevTest Labs Parent Resource</h3><p>This resource is relatively simple; shouldn&rsquo;t have too much of an issue here! Not going into detail here but for completeness, this is what I used as my parent.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;[parameters(&#39;devTestLabName&#39;)]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;Microsoft.DevTestLab/labs&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-15&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;location&#34;</span><span class=p>:</span> <span class=s2>&#34;[parameters(&#39;location&#39;)]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;labStorageType&#34;</span><span class=p>:</span> <span class=s2>&#34;Premium&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;premiumDataDisks&#34;</span><span class=p>:</span> <span class=s2>&#34;Enabled&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=userownedlabvmcount>UserOwnedLabVmCount</h3><p>This is where I first realised that threshold only accepts a string. My first assumption was that another field (factData) held strings and threshold held integers. That&rsquo;s not the case.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;[concat(parameters(&#39;devTestLabName&#39;), &#39;/default/UserOwnedLabVmCount&#39;)]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;Microsoft.DevTestLab/labs/policysets/policies&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-15&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependsOn&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;[resourceId(&#39;Microsoft.DevTestLab/labs&#39;, parameters(&#39;devTestLabName&#39;))]&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;Enabled&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;factName&#34;</span><span class=p>:</span> <span class=s2>&#34;UserOwnedLabVmCount&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;threshold&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;evaluatorType&#34;</span><span class=p>:</span> <span class=s2>&#34;MaxValuePolicy&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>There doesn&rsquo;t appear to be a max value for UserOwnedLabVmCount. I tried 999,999 and it took. If that&rsquo;s something you&rsquo;d like to control in a parameter you can use a parameter of type int where you can set maxValue then for the threshold property use:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=s2>&#34;threshold&#34;</span><span class=err>:</span> <span class=s2>&#34;[string(parameter(&#39;UserOwnedLabVmCountValue&#39;))]&#34;</span>
</span></span></code></pre></div><h3 id=userownedlabpremiumvmcount>UserOwnedLabPremiumVmCount</h3><p>Practically identical to the above!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;[concat(parameters(&#39;devTestLabName&#39;), &#39;/default/UserOwnedLabPremiumVmCount&#39;)]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;Microsoft.DevTestLab/labs/policysets/policies&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-15&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependsOn&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;[resourceId(&#39;Microsoft.DevTestLab/labs&#39;, parameters(&#39;devTestLabName&#39;))]&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;Enabled&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;factName&#34;</span><span class=p>:</span> <span class=s2>&#34;UserOwnedLabPremiumVmCount&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;threshold&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;evaluatorType&#34;</span><span class=p>:</span> <span class=s2>&#34;MaxValuePolicy&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=labvmcount>LabVmCount</h3><p>Another practically identical resource to the two previous policies&mldr; If only they were all this easy!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;[concat(parameters(&#39;devTestLabName&#39;), &#39;/default/LabVmCount&#39;)]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;Microsoft.DevTestLab/labs/policysets/policies&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-15&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependsOn&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;[resourceId(&#39;Microsoft.DevTestLab/labs&#39;, parameters(&#39;devTestLabName&#39;))]&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;Enabled&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;factName&#34;</span><span class=p>:</span> <span class=s2>&#34;LabVmCount&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;threshold&#34;</span><span class=p>:</span> <span class=s2>&#34;10&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;evaluatorType&#34;</span><span class=p>:</span> <span class=s2>&#34;MaxValuePolicy&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=labpremiumvmcount>LabPremiumVmCount</h3><p>And again&mldr; But this time a little caveat. This policy requires that the DevTest lab property <code>labStorageType</code> is set to <code>Premium</code>. ARM will throw a seemingly unrelated error if this is not set. I learnt this as initially my DevTest lab was set to StandardSSD.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;[concat(parameters(&#39;devTestLabName&#39;), &#39;/default/LabPremiumVmCount&#39;)]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;Microsoft.DevTestLab/labs/policysets/policies&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-15&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependsOn&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;[resourceId(&#39;Microsoft.DevTestLab/labs&#39;, parameters(&#39;devTestLabName&#39;))]&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;Enabled&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;factName&#34;</span><span class=p>:</span> <span class=s2>&#34;LabPremiumVmCount&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;threshold&#34;</span><span class=p>:</span> <span class=s2>&#34;10&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;evaluatorType&#34;</span><span class=p>:</span> <span class=s2>&#34;MaxValuePolicy&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=labvmsize>LabVmSize</h3><p>Okay, this one is different. Really. It&rsquo;s our first policy that doesn&rsquo;t just require a integer (.. as a string).</p><p>The solution for LabVmSize is to use a parameter of type array and parse that as a string. The array is just your standard Azure VM sizes in a list. To be verbose, this is the template resource component:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;[concat(parameters(&#39;devTestLabName&#39;), &#39;/default/LabVmSize&#39;)]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;Microsoft.DevTestLab/labs/policysets/policies&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-15&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependsOn&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;[resourceId(&#39;Microsoft.DevTestLab/labs&#39;, parameters(&#39;devTestLabName&#39;))]&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;Enabled&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;factName&#34;</span><span class=p>:</span> <span class=s2>&#34;LabVmSize&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;threshold&#34;</span><span class=p>:</span> <span class=s2>&#34;[string(parameters(&#39;allowedLabVmSizes&#39;))]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;evaluatorType&#34;</span><span class=p>:</span> <span class=s2>&#34;AllowedValuesPolicy&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>And the parameter component:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=s2>&#34;allowedLabVmSizes&#34;</span><span class=err>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Basic_A0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Basic_A1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Basic_A2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Basic_A3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Basic_A4&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=galleryimage>GalleryImage</h3><p>This one beat me. I searched for <code>"/default/GalleryImage"</code> and found another blog that had managed to template this value. I wonder if they struggled as much as I did.</p><p>At first glance this policy is very similar to the one directly above. It accepts a JSON array as a string containing the usual details about the image reference. But for reasons that are beyond my comprehension they wouldn&rsquo;t stick. So, this is the template:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;[concat(parameters(&#39;devTestLabName&#39;), &#39;/default/GalleryImage&#39;)]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;Microsoft.DevTestLab/labs/policysets/policies&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-15&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependsOn&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;[resourceId(&#39;Microsoft.DevTestLab/labs&#39;, parameters(&#39;devTestLabName&#39;))]&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;Enabled&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;factName&#34;</span><span class=p>:</span> <span class=s2>&#34;GalleryImage&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;threshold&#34;</span><span class=p>:</span> <span class=s2>&#34;[concat(&#39;[&#39;, trim(parameters(&#39;allowedLabGalleryImages&#39;)), &#39;]&#39;)]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;evaluatorType&#34;</span><span class=p>:</span> <span class=s2>&#34;AllowedValuesPolicy&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>And as messy as it looks, this is how to provide a parameter file value to this resource.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=s2>&#34;allowedLabGalleryImages&#34;</span><span class=err>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;\&#34;{\\\&#34;offer\\\&#34;:\\\&#34;WindowsServer\\\&#34;,\\\&#34;publisher\\\&#34;:\\\&#34;MicrosoftWindowsServer\\\&#34;,\\\&#34;sku\\\&#34;:\\\&#34;2019-Datacenter\\\&#34;,\\\&#34;osType\\\&#34;:\\\&#34;Windows\\\&#34;,\\\&#34;version\\\&#34;:\\\&#34;latest\\\&#34;}\&#34;,\&#34;{\\\&#34;offer\\\&#34;:\\\&#34;WindowsServer\\\&#34;,\\\&#34;publisher\\\&#34;:\\\&#34;MicrosoftWindowsServer\\\&#34;,\\\&#34;sku\\\&#34;:\\\&#34;2016-Datacenter\\\&#34;,\\\&#34;osType\\\&#34;:\\\&#34;Windows\\\&#34;,\\\&#34;version\\\&#34;:\\\&#34;latest\\\&#34;}\&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></div><p>Not how I wanted it to look, at all. The above parameter value contains two image references that should help with adding additional values if you need to add more. It might help to break the value up onto multiple lines to help visualise what part you&rsquo;ll need to copy/paste.</p><h3 id=unfinished-policies>Unfinished Policies</h3><p>Unfortunately, I&rsquo;ve not managed to template for policies: <code>UserOwnedLabVmCountInSubnet</code>, <code>LabTargetCost</code>, <code>EnvironmentTemplate</code> and <code>ScheduleEditPermission</code>. I&rsquo;ll come back to them but just in case I don&rsquo;t in the near future (or, ever) I&rsquo;ve listed some references that may or may not be helpful.</p><p>My approach to find the correct values for each policy has been to make the change in the Azure Portal then retrieve the Policy details back via PowerShell. I used a couple lines of script borrowed from the <a class=link href=https://docs.microsoft.com/en-gb/azure/devtest-labs/scripts/set-allowed-vm-sizes-in-lab#sample-script target=_blank rel=noopener>DevTest Labs documentation</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$lab</span> <span class=p>=</span> <span class=nb>Get-AzResource</span> <span class=n>-ResourceType</span> <span class=s1>&#39;Microsoft.DevTestLab/labs&#39;</span> <span class=n>-ResourceName</span> <span class=n>myDevTestLab</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$labResourceName</span> <span class=p>=</span> <span class=nv>$lab</span><span class=p>.</span><span class=n>Name</span> <span class=p>+</span> <span class=s1>&#39;/default&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$existingPolicy</span> <span class=p>=</span> <span class=p>(</span><span class=nb>Get-AzResource</span> <span class=n>-ResourceType</span> <span class=s1>&#39;Microsoft.DevTestLab/labs/policySets/policies&#39;</span> <span class=n>-ResourceName</span> <span class=nv>$labResourceName</span> <span class=n>-ResourceGroupName</span> <span class=nv>$lab</span><span class=p>.</span><span class=n>ResourceGroupName</span> <span class=n>-ApiVersion</span> <span class=n>2016</span><span class=p>-</span><span class=n>05</span><span class=p>-</span><span class=n>15</span><span class=p>)</span>
</span></span></code></pre></div><p>You can update $existingPolicy whenever you make a change to the policies.</p><p><code>$existingPolicy.Count</code> - will return the number of configured policy resources.
<code>$existingPolicy[0]</code> - will return the first policy configured on the DevTest lab.
<code>$existingPolicy[0].Properties</code> - will return the properties of a configured policy. It&rsquo;s this information that you&rsquo;ll need to configure policies.
In the case of at least GalleyImage you might find it easier to read if you run <code>$existingPolicy[0].Properties.threshold | ConvertFrom-Json</code></p><h3 id=references>References</h3><p><a class=link href=https://docs.microsoft.com/en-gb/azure/templates/microsoft.devtestlab/labs target=_blank rel=noopener>ARM Docs: DevTest Labs</a></p><p><a class=link href=https://docs.microsoft.com/en-gb/azure/templates/microsoft.devtestlab/labs/policysets/policies target=_blank rel=noopener>ARM Docs: DevTest Labs Policies</a></p><p><a class=link href=https://integrationworkz.antiohne.nl/2018/11/deploy-with-arm-templates-azure-devtest.html target=_blank rel=noopener>GalleryImage</a> - The blog that helped me solve GalleryImage.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/azure/>Azure</a>
<a href=/tags/devtest-labs/>DevTest Labs</a>
<a href=/tags/arm-templates/>ARM Templates</a></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//mattdaines.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2021 -
2022 Matt Daines</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.9.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>