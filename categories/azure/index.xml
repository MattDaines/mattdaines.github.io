<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Azure on Technology Notebook</title><link>https://notebook.mattdaines.me/categories/azure/</link><description>Recent content in Azure on Technology Notebook</description><generator>Hugo -- gohugo.io</generator><language>en-gb</language><lastBuildDate>Wed, 13 Sep 2023 00:00:00 +0000</lastBuildDate><atom:link href="https://notebook.mattdaines.me/categories/azure/index.xml" rel="self" type="application/rss+xml"/><item><title>My Default Azure Firewall Rules</title><link>https://notebook.mattdaines.me/p/my-default-azure-firewall-rules/</link><pubDate>Wed, 13 Sep 2023 00:00:00 +0000</pubDate><guid>https://notebook.mattdaines.me/p/my-default-azure-firewall-rules/</guid><description>&lt;p>Typically, in a Cloud Adoption Framework Landing Zone you will use an Azure Firewall to filter traffic heading to the Internet. If you are using a standard tier Azure Firewall or Firewall Policy you will not be able to use web categories, so you will need to create a rule for each FQDN that you want to allow. It can be a pain to find all the FQDNs that you need to allow, so I have created a list of the FQDNs that I typically allow as a starting point. I&amp;rsquo;ll then look through the firewall logs to see if there are any other FQDNs that I need to allow.&lt;/p>
&lt;blockquote>
&lt;p>I&amp;rsquo;m going to add to this page as I discover more endpoints that I need to allow.&lt;/p>
&lt;/blockquote>
&lt;h2 id="public-key-infrastructure-pki">Public Key Infrastructure (PKI)&lt;/h2>
&lt;h3 id="oscps">OSCPs&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>FQDN&lt;/th>
&lt;th>Protocol&lt;/th>
&lt;th>Port&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>ocsp.digicert.com&lt;/td>
&lt;td>TCP&lt;/td>
&lt;td>80&lt;/td>
&lt;td>OCSP for DigiCert&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ts-ocsp.ws.symantec.com&lt;/td>
&lt;td>TCP&lt;/td>
&lt;td>80&lt;/td>
&lt;td>OCSP for Symantec&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ocsp.comodoca.com&lt;/td>
&lt;td>TCP&lt;/td>
&lt;td>80&lt;/td>
&lt;td>OCSP for Comodo&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>oneocsp.microsoft.com&lt;/td>
&lt;td>TCP&lt;/td>
&lt;td>80&lt;/td>
&lt;td>OCSP for Microsoft&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="crl">CRL&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>FQDN&lt;/th>
&lt;th>Protocol&lt;/th>
&lt;th>Port&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>crl3.digicert.com, crl4.digicert.com&lt;/td>
&lt;td>TCP&lt;/td>
&lt;td>80&lt;/td>
&lt;td>CRL for DigiCert&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>crl.verisign.com&lt;/td>
&lt;td>TCP&lt;/td>
&lt;td>80&lt;/td>
&lt;td>CRL for Symantec&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>crl.comodoca.com&lt;/td>
&lt;td>TCP&lt;/td>
&lt;td>80&lt;/td>
&lt;td>CRL for Comodo&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="azure-defaults">Azure Defaults&lt;/h2>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>FQDN&lt;/th>
&lt;th>Protocol&lt;/th>
&lt;th>Port&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>time.windows.com&lt;/td>
&lt;td>UDP&lt;/td>
&lt;td>123&lt;/td>
&lt;td>Default time server for Windows based OS&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>azkms.core.windows.net, kms.core.windows.net&lt;/td>
&lt;td>TCO&lt;/td>
&lt;td>1688&lt;/td>
&lt;td>KMS server for Windows based OS. &lt;a class="link" href="https://azure.microsoft.com/en-gb/updates/new-kms-dns-in-azure-global-cloud/" target="_blank" rel="noopener"
>Source 1 - Annoucement&lt;/a> &lt;a class="link" href="https://learn.microsoft.com/en-gb/troubleshoot/azure/virtual-machines/custom-routes-enable-kms-activation#solution" target="_blank" rel="noopener"
>Source 2 - Activation Troubleshooting&lt;/a>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table></description></item><item><title>Authenticating as a Service Principal</title><link>https://notebook.mattdaines.me/p/authenticating-as-a-service-principal/</link><pubDate>Fri, 19 May 2023 00:00:00 +0000</pubDate><guid>https://notebook.mattdaines.me/p/authenticating-as-a-service-principal/</guid><description>&lt;img src="https://notebook.mattdaines.me/p/authenticating-as-a-service-principal/header-image.png" alt="Featured image of post Authenticating as a Service Principal" />&lt;p>On rare occasions, you may sometimes need to log in with an Azure service principal. Below is a code snippet that you can use to authenticate as a service principal. You will need to know the client ID and either know a client secret that has been generated or have access to a client certificate.&lt;/p>
&lt;p>Once signed in, you &lt;em>are&lt;/em> that service principal. So running commands like &lt;code>Get-AzSubscription&lt;/code> or &lt;code>Get-AzResourceGroup&lt;/code> may help with identifying role-based access control issues.&lt;/p>
&lt;h2 id="login-as-service-principal-with-secret">Login As Service Principal with Secret&lt;/h2>
&lt;h3 id="powershell">PowerShell&lt;/h3>
&lt;p>Reference: &lt;a class="link" href="https://learn.microsoft.com/en-us/powershell/module/az.accounts/connect-azaccount#example-3-connect-to-azure-using-a-service-principal-account" target="_blank" rel="noopener"
>MS Learn - Connect to Azure using a service principal account&lt;/a>&lt;/p>
&lt;p>This snippet is really here because I forget how to generate the &lt;code>$Credential&lt;/code> object everytime I need to do this!&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Stores what is effectively the username and password in two variables.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ClientId&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mf">00000000&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="mf">0000&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="mf">0000&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="mf">0000&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="mf">000000000000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ClientPassword&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">Generated&lt;/span> &lt;span class="n">Secret&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Creates a PSCredential object using the username and password&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Credential&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-Object&lt;/span> &lt;span class="n">-TypeName&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Management&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Automation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">PSCredential&lt;/span> &lt;span class="p">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="nv">$ClientId&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$ClientPassword&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ConvertTo-SecureString&lt;/span> &lt;span class="n">-AsPlainText&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Uses the PSCredential object to authenticate with Azure to a particular Azure tenant&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Connect-AzAccount&lt;/span> &lt;span class="n">-ServicePrincipal&lt;/span> &lt;span class="p">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">-TenantId&lt;/span> &lt;span class="nv">$TenantId&lt;/span> &lt;span class="p">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">-Credential&lt;/span> &lt;span class="nv">$Credential&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Enabling/Disabling Network Level Authentication (NLA)</title><link>https://notebook.mattdaines.me/p/enabling/disabling-network-level-authentication-nla/</link><pubDate>Tue, 09 May 2023 00:00:00 +0000</pubDate><guid>https://notebook.mattdaines.me/p/enabling/disabling-network-level-authentication-nla/</guid><description>&lt;blockquote>
&lt;p>The remote computer that you are trying to connect to requires Network Level Authentication (NLA), but your Windows domain controller cannot be contacted to perform NLA. If you are an administrator on the remote computer, you can disable NLA by using the options on the Remote tab of the System Properties dialog box.&lt;/p>
&lt;/blockquote>
&lt;p>A frustrating error that you may occasionally bump into while configuring Windows server infrastructure. It&amp;rsquo;s likely that a networking issue is preventing the member server from contacting the domain controller. Even after the networking issue is resolved, a domain admin (or, another privileged admin) would need to re-establish the trust to the domain controller from the member server.&lt;/p>
&lt;p>My, admittedly somewhat limited knowledge of the issue of why this happens is when the domain member tries to reset it&amp;rsquo;s own password/credential and can&amp;rsquo;t due to a network issue (I&amp;rsquo;m sure there&amp;rsquo;s other reason, but that&amp;rsquo;s the most common from my personal experience). The machine password expires and then the member server cannot authenticate to the domain, which is part of the authentication process for domain accounts when NLA is enabled.&lt;/p>
&lt;p>This page will list a few PowerShell cmdlets that I run when I&amp;rsquo;m happy that the member server can be brought back. Just don&amp;rsquo;t forget to re-enable NLA once you&amp;rsquo;re the computer is trusted again.&lt;/p>
&lt;h2 id="disable-network-level-authentication-nla">Disable Network Level Authentication (NLA)&lt;/h2>
&lt;p>In Azure, you likely need to run this from the Run Command blade on the target virtual machine.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-class&lt;/span> &lt;span class="n">Win32_TSGeneralSetting&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">cimv2&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">terminalservices&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">hostname&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s2">&amp;#34;TerminalName=&amp;#39;RDP-tcp&amp;#39;&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">SetUserAuthenticationRequired&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>You should now be able to remote on with the local administrator account. If you&amp;rsquo;re not sure what the local administrator account is, you can use the Reset Password blade in the Azure portal - this creates a new local admin account if it does not already exist or resets the password if it does.&lt;/p>
&lt;h2 id="domain-trust">Domain Trust&lt;/h2>
&lt;p>If you successfully remote onto the virtual machine with the local admin credential, you can now reset the computer password and re-establish the trust with the domain.&lt;/p>
&lt;p>For &lt;code>&amp;lt;Domain&amp;gt;\&amp;lt;User&amp;gt;&lt;/code> you&amp;rsquo;ll want to use the domain account, not the local account. You&amp;rsquo;ll be prompted for the password.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Reset-ComputerMachinePassword&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">Domain&lt;/span>&lt;span class="p">&amp;gt;\&amp;lt;&lt;/span>&lt;span class="n">User&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="enable-network-level-authentication-nla">Enable Network Level Authentication (NLA)&lt;/h2>
&lt;p>Assuming the &lt;code>Reset-ComputerMachinePassword&lt;/code> succeeded, you can now re-enable NLA and log back on with your domain account.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-class&lt;/span> &lt;span class="n">Win32_TSGeneralSetting&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">cimv2&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">terminalservices&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">hostname&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s2">&amp;#34;TerminalName=&amp;#39;RDP-tcp&amp;#39;&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">SetUserAuthenticationRequired&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item></channel></rss>