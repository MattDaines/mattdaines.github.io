[{"content":"Typically, in a Cloud Adoption Framework Landing Zone you will use an Azure Firewall to filter traffic heading to the Internet. If you are using a standard tier Azure Firewall or Firewall Policy you will not be able to use web categories, so you will need to create a rule for each FQDN that you want to allow. It can be a pain to find all the FQDNs that you need to allow, so I have created a list of the FQDNs that I typically allow as a starting point. I\u0026rsquo;ll then look through the firewall logs to see if there are any other FQDNs that I need to allow.\nI\u0026rsquo;m going to add to this page as I discover more endpoints that I need to allow.\nPublic Key Infrastructure (PKI) OSCPs FQDN Protocol Port Description ocsp.digicert.com TCP 80 OCSP for DigiCert ts-ocsp.ws.symantec.com TCP 80 OCSP for Symantec ocsp.comodoca.com TCP 80 OCSP for Comodo oneocsp.microsoft.com TCP 80 OCSP for Microsoft CRL FQDN Protocol Port Description crl3.digicert.com, crl4.digicert.com TCP 80 CRL for DigiCert crl.verisign.com TCP 80 CRL for Symantec crl.comodoca.com TCP 80 CRL for Comodo Azure Defaults FQDN Protocol Port Description time.windows.com UDP 123 Default time server for Windows based OS azkms.core.windows.net, kms.core.windows.net TCO 1688 KMS server for Windows based OS. Source 1 - Annoucement Source 2 - Activation Troubleshooting ","date":"2023-09-13T00:00:00Z","permalink":"https://notebook.mattdaines.me/p/my-default-azure-firewall-rules/","title":"My Default Azure Firewall Rules"},{"content":"On rare occasions, you may sometimes need to log in with an Azure service principal. Below is a code snippet that you can use to authenticate as a service principal. You will need to know the client ID and either know a client secret that has been generated or have access to a client certificate.\nOnce signed in, you are that service principal. So running commands like Get-AzSubscription or Get-AzResourceGroup may help with identifying role-based access control issues.\nLogin As Service Principal with Secret PowerShell Reference: MS Learn - Connect to Azure using a service principal account\nThis snippet is really here because I forget how to generate the $Credential object everytime I need to do this!\n1 2 3 4 5 6 7 8 9 10 11 12 # Stores what is effectively the username and password in two variables. $ClientId = 00000000-0000-0000-0000-000000000000 $ClientPassword = \u0026lt;Generated Secret\u0026gt; # Creates a PSCredential object using the username and password $Credential = New-Object -TypeName System.Management.Automation.PSCredential ` -ArgumentList $ClientId, ($ClientPassword | ConvertTo-SecureString -AsPlainText) # Uses the PSCredential object to authenticate with Azure to a particular Azure tenant Connect-AzAccount -ServicePrincipal ` -TenantId $TenantId ` -Credential $Credential ","date":"2023-05-19T00:00:00Z","image":"https://notebook.mattdaines.me/p/authenticating-as-a-service-principal/header-image_hu6509318eda23a36a2124f900271e8a7f_64346_120x120_fill_box_smart1_3.png","permalink":"https://notebook.mattdaines.me/p/authenticating-as-a-service-principal/","title":"Authenticating as a Service Principal"},{"content":" The remote computer that you are trying to connect to requires Network Level Authentication (NLA), but your Windows domain controller cannot be contacted to perform NLA. If you are an administrator on the remote computer, you can disable NLA by using the options on the Remote tab of the System Properties dialog box.\nA frustrating error that you may occasionally bump into while configuring Windows server infrastructure. It\u0026rsquo;s likely that a networking issue is preventing the member server from contacting the domain controller. Even after the networking issue is resolved, a domain admin (or, another privileged admin) would need to re-establish the trust to the domain controller from the member server.\nMy, admittedly somewhat limited knowledge of the issue of why this happens is when the domain member tries to reset it\u0026rsquo;s own password/credential and can\u0026rsquo;t due to a network issue (I\u0026rsquo;m sure there\u0026rsquo;s other reason, but that\u0026rsquo;s the most common from my personal experience). The machine password expires and then the member server cannot authenticate to the domain, which is part of the authentication process for domain accounts when NLA is enabled.\nThis page will list a few PowerShell cmdlets that I run when I\u0026rsquo;m happy that the member server can be brought back. Just don\u0026rsquo;t forget to re-enable NLA once you\u0026rsquo;re the computer is trusted again.\nDisable Network Level Authentication (NLA) In Azure, you likely need to run this from the Run Command blade on the target virtual machine.\n1 (Get-WmiObject -class Win32_TSGeneralSetting -Namespace root\\cimv2\\terminalservices -ComputerName (hostname) -Filter \u0026#34;TerminalName=\u0026#39;RDP-tcp\u0026#39;\u0026#34;).SetUserAuthenticationRequired(0) You should now be able to remote on with the local administrator account. If you\u0026rsquo;re not sure what the local administrator account is, you can use the Reset Password blade in the Azure portal - this creates a new local admin account if it does not already exist or resets the password if it does.\nDomain Trust If you successfully remote onto the virtual machine with the local admin credential, you can now reset the computer password and re-establish the trust with the domain.\nFor \u0026lt;Domain\u0026gt;\\\u0026lt;User\u0026gt; you\u0026rsquo;ll want to use the domain account, not the local account. You\u0026rsquo;ll be prompted for the password.\n1 Reset-ComputerMachinePassword -Credential \u0026lt;Domain\u0026gt;\\\u0026lt;User\u0026gt; Enable Network Level Authentication (NLA) Assuming the Reset-ComputerMachinePassword succeeded, you can now re-enable NLA and log back on with your domain account.\n1 (Get-WmiObject -class Win32_TSGeneralSetting -Namespace root\\cimv2\\terminalservices -ComputerName (hostname) -Filter \u0026#34;TerminalName=\u0026#39;RDP-tcp\u0026#39;\u0026#34;).SetUserAuthenticationRequired(1) ","date":"2023-05-09T00:00:00Z","permalink":"https://notebook.mattdaines.me/p/enabling/disabling-network-level-authentication-nla/","title":"Enabling/Disabling Network Level Authentication (NLA)"}]